{%extends 'user/base_center.html'%}


{%block right%}
		<div class="right_content clearfix">
				<h3 class="common_title2">全部订单</h3>
			    {%for order in order_page%}
				<ul class="order_list_th w978 clearfix">
					<li class="col01">{{order.create_time}}</li>
					<li class="col02">订单号：{{order.order_id}}</li>
					<li class="col02 stress">{{order.get_order_status_display}}</li>
				</ul>
				<table class="order_list_table w980">
					<tbody>
						<tr>
							<td width="55%">
								{%for order_sku in order.order_skus%}
								<ul class="order_goods_list clearfix">					
									<li class="col01"><img src="{{order_sku.sku.image.url}}"></li>
									<li class="col02">{{order_sku.sku.name}}<em>{{order_sku.sku.prince}}元/{{order_sku.sku.unite}}</em></li>
									<li class="col03">{{order_sku.count}}</li>
									<li class="col04">{{order_sku.amount}}元</li>
								</ul>
                                 {%endfor%}
							</td>
							<td width="15%">{{order.total_price|add:order.transit_price}}(含运费：{{order.transit_price}})元</td>
							<td width="15%">{{order.get_order_status_display}}</td>
							<td width="15%"><a href="#" class="oper_btn" status="{{order.order_status}}" order_id="{{order.order_id}}">去付款</a></td>
							{% csrf_token %}
						</tr>
					</tbody>
				</table>
			   {%endfor%}
				<div class="pagenation">
					{% if order_page.has_previous %}
					   <a href="{% url 'user:order' order_page.previous_page_number %}"><上一页</a>
					{% else %}
					   <a href="#"><上一页</a>
					{% endif %}
					{% for page in pages %}
						   {% if page == order_page.number %}
							  <a href="#" class="active">{{page}}</a>
						   {% else %}
							   <a href="{% url 'user:order' page %}">{{page}}</a>
						   {% endif %}
					{% endfor %}

					{% if order_page.has_next %}
					  <a href="{% url 'user:order' order_page.next_page_number %}">下一页></a>
					{% else %}
					   <a href="#">下一页></a>
					{% endif %}
			</div>
		</div>

{%endblock right%}

{%block foot%}
<script>
	$('.oper_btn').each(function () {
		status=$(this).attr('status');
		if(status==1){
		    $(this).text('去支付')
		}
		else if(status==4){
		    $(this).text('去评价')
		}
		else if(status==5){
		    $(this).text('已完成')
		}
    });
	$('.oper_btn').click(function () {
		status=$(this).attr('status');
		order_id=$(this).attr('order_id');
		csrf=$('input[name="csrfmiddlewaretoken"]').val();
		params={
			'order_id':order_id,
			'csrfmiddlewaretoken':csrf,
		}
		if(status==1){
		    $.post("{% url 'order:pay' %}",params,function (data) {
				if(data.res==3){
				    //引导用户到支付页面
				    window.open(data.pay_url)
					//浏览器访问/order/check,获取支付交易结果
					$.post("{% url 'order:check' %}",params,function (data) {
						if(data.res==3){
						    alert(data.message)
							//刷新页面
							location.reload()
						}
						else{
		                   alert(data.errmsg);
						}
                    })
				}
            });
		}
		else if(status==4){
		    location.href='/order/comment/'+order_id
		}
		else{
		    alert(data.errmsg);
		}
    })
</script>
{%endblock foot%}